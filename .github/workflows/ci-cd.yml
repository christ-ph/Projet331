name: CI/CD Projet331

on:
  push:
    branches: [main, christ_branch]
  pull_request:
    branches: [main]

jobs:
  # ğŸ” VÃ‰RIFICATION DE LA STRUCTURE
  check_structure:
    runs-on: ubuntu-latest
    name: ğŸ” VÃ©rifier la structure du projet
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ“ Analyser la structure
      run: |
        echo "ğŸ“Š STRUCTURE COMPLÃˆTE DU PROJET:"
        echo "================================"
        find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.vue" -o -name "*.json" \) | head -30
        echo ""
        echo "ğŸ“‹ RACINE DU PROJET:"
        ls -la
        echo ""
        echo "ğŸ” RECHERCHE BACKEND:"
        find . -name "requirements.txt" -o -name "app.py" -o -name "models" -type d | head -10
        echo ""
        echo "ğŸ” RECHERCHE FRONTEND:"
        find . -name "package.json" -o -name "vue.config.js" -o -name "src" -type d | head -10

  # ğŸ BACKEND VALIDATION
  backend_test:
    runs-on: ubuntu-latest
    name: ğŸ Validation Backend
    needs: check_structure
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: christ
          POSTGRES_PASSWORD: 123456
          POSTGRES_DB: freelance_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Installer dÃ©pendances Python
      run: |
        pip install flask flask-sqlalchemy psycopg2-binary

    - name: ğŸ” Valider environnement Python
      run: |
        python -c "
        try:
            import flask
            import flask_sqlalchemy
            import psycopg2
            print('âœ… Tous les imports Python fonctionnent')
        except ImportError as e:
            print(f'âŒ Import manquant: {e}')
            exit(1)
        "

    - name: ğŸ” Tester connexion PostgreSQL
      run: |
        python -c "
        import psycopg2
        try:
            conn = psycopg2.connect(
                host='localhost',
                database='freelance_db',
                user='christ',
                password='123456',
                port=5432
            )
            print('âœ… Connexion PostgreSQL rÃ©ussie')
            conn.close()
        except Exception as e:
            print(f'âŒ Erreur PostgreSQL: {e}')
            exit(1)
        "

    - name: âœ… Backend validÃ©
      run: echo "ğŸ‰ Backend opÃ©rationnel"

  # âš›ï¸ FRONTEND BUILD
  frontend_build:
    runs-on: ubuntu-latest
    name: âš›ï¸ Build Frontend Vue.js
    needs: check_structure
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: â” Configuration Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Installer dÃ©pendances
      run: |
        if [ -f "package.json" ]; then
          npm ci
          echo "âœ… DÃ©pendances npm installÃ©es"
        else
          echo "âŒ package.json non trouvÃ© - Ã©chec du build frontend"
          echo "ğŸ“ Fichiers prÃ©sents:"
          ls -la
          exit 1
        fi

    - name: ğŸ”¨ Build Vue.js
      run: |
        if npm run | grep -q "build"; then
          npm run build
          echo "âœ… Build Vue.js rÃ©ussi"
        else
          echo "âŒ Script 'build' non trouvÃ© dans package.json"
          echo "ğŸ“‹ Scripts disponibles:"
          npm run
          exit 1
        fi

    - name: ğŸ“Š VÃ©rifier le build
      run: |
        if [ -d "dist" ]; then
          echo "âœ… Dossier dist/ gÃ©nÃ©rÃ© avec succÃ¨s"
          echo "ğŸ“ Contenu:"
          ls -la dist/
        else
          echo "âŒ Dossier dist/ non gÃ©nÃ©rÃ©"
          exit 1
        fi

  # ğŸ“Š RAPPORT FINAL
  deployment_report:
    runs-on: ubuntu-latest
    name: ğŸ“Š Rapport de dÃ©ploiement
    needs: [backend_test, frontend_build]
    # ExÃ©cuter seulement sur la branche main
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“‹ GÃ©nÃ©rer rapport
      run: |
        echo "ğŸš€ RAPPORT CI/CD - PROJET331"
        echo "============================="
        echo "âœ… Backend: Environnement Python/Flask validÃ©"
        echo "âœ… Frontend: Build Vue.js rÃ©ussi" 
        echo "âœ… PostgreSQL: Base de donnÃ©es opÃ©rationnelle"
        echo ""
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”„ Branche: ${{ github.ref }}"
        echo "ğŸ‘¤ DÃ©clencheur: ${{ github.actor }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo ""
        echo "ğŸŒ ENVIRONNEMENT VALIDÃ‰:"
        echo "   â€¢ Python 3.9 + Flask"
        echo "   â€¢ Node.js 18 + Vue.js"
        echo "   â€¢ PostgreSQL 13"
        echo ""
        echo "ğŸ‰ APPLICATION PRÃŠTE POUR LE DÃ‰PLOIEMENT !"